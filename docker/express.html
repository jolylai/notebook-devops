<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Express 服务 | Devops</title>
    <meta name="description" content="🚀 持续构建">
    <link rel="icon" href="/notebook-devops/favicon.ico">
    
    <link rel="preload" href="/notebook-devops/assets/css/0.styles.410fc542.css" as="style"><link rel="preload" href="/notebook-devops/assets/js/app.5041fe57.js" as="script"><link rel="preload" href="/notebook-devops/assets/js/2.c3326ad1.js" as="script"><link rel="preload" href="/notebook-devops/assets/js/10.b17c6e86.js" as="script"><link rel="prefetch" href="/notebook-devops/assets/js/11.fbae0a6c.js"><link rel="prefetch" href="/notebook-devops/assets/js/12.80dfaa08.js"><link rel="prefetch" href="/notebook-devops/assets/js/13.80280d56.js"><link rel="prefetch" href="/notebook-devops/assets/js/14.0f96825a.js"><link rel="prefetch" href="/notebook-devops/assets/js/15.31790600.js"><link rel="prefetch" href="/notebook-devops/assets/js/16.27bbdc0e.js"><link rel="prefetch" href="/notebook-devops/assets/js/17.cbc4020b.js"><link rel="prefetch" href="/notebook-devops/assets/js/18.7f01973c.js"><link rel="prefetch" href="/notebook-devops/assets/js/19.26c1d983.js"><link rel="prefetch" href="/notebook-devops/assets/js/20.5e74133d.js"><link rel="prefetch" href="/notebook-devops/assets/js/21.d0684304.js"><link rel="prefetch" href="/notebook-devops/assets/js/22.4f6d3c88.js"><link rel="prefetch" href="/notebook-devops/assets/js/23.571fdfa3.js"><link rel="prefetch" href="/notebook-devops/assets/js/24.c3443493.js"><link rel="prefetch" href="/notebook-devops/assets/js/25.da53f94f.js"><link rel="prefetch" href="/notebook-devops/assets/js/3.5e63f843.js"><link rel="prefetch" href="/notebook-devops/assets/js/4.e16cae01.js"><link rel="prefetch" href="/notebook-devops/assets/js/5.ed0dbbc2.js"><link rel="prefetch" href="/notebook-devops/assets/js/6.7bf6aa28.js"><link rel="prefetch" href="/notebook-devops/assets/js/7.e5e0fe96.js"><link rel="prefetch" href="/notebook-devops/assets/js/8.0ef6f4e6.js"><link rel="prefetch" href="/notebook-devops/assets/js/9.a95889fb.js">
    <link rel="stylesheet" href="/notebook-devops/assets/css/0.styles.410fc542.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook-devops/" class="home-link router-link-active"><!----> <span class="site-name">Devops</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook-devops/architect/lint.html" class="nav-link">Architect</a></div><div class="nav-item"><a href="/notebook-devops/travis/" class="nav-link">Travis</a></div><div class="nav-item"><a href="/notebook-devops/docker/start/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/notebook-devops/git/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/notebook-devops/linux/" class="nav-link">Linux</a></div> <a href="https://github.com/Jolylai/notebook-devops" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook-devops/architect/lint.html" class="nav-link">Architect</a></div><div class="nav-item"><a href="/notebook-devops/travis/" class="nav-link">Travis</a></div><div class="nav-item"><a href="/notebook-devops/docker/start/" class="nav-link">Docker</a></div><div class="nav-item"><a href="/notebook-devops/git/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="/notebook-devops/linux/" class="nav-link">Linux</a></div> <a href="https://github.com/Jolylai/notebook-devops" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook-devops/docker/start.html" class="sidebar-link">Start</a></li><li><a href="/notebook-devops/docker/install.html" class="sidebar-link">Install</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Deploy</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook-devops/docker/react.html" class="sidebar-link">React项目部署</a></li><li><a href="/notebook-devops/docker/express.html" class="active sidebar-link">Express 服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook-devops/docker/express.html#containerise" class="sidebar-link">Containerise</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="express-服务"><a href="#express-服务" aria-hidden="true" class="header-anchor">#</a> Express 服务</h1> <h2 id="containerise"><a href="#containerise" aria-hidden="true" class="header-anchor">#</a> Containerise</h2> <p>We would try to containerise very node.js simple app, and create a image:</p> <h3 id="your-node-js-app"><a href="#your-node-js-app" aria-hidden="true" class="header-anchor">#</a> Your Node.js App</h3> <p>Let’s start by creating folder my-node-app ,</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> my-node-app
<span class="token function">cd</span> my-node-app
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>let ‘s create a simple node server in index.js and add following code there:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//Load express module with `require` directive</span>

<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Define request response in root URL (/)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Launch listening server on port 8081</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8081</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;app listening on port 8081!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>and save this file inside your my-node-app folder.</p> <p>Now we create a <code>package.json</code> file and add following code there:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;helloworld&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dockerized node.js app&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;express&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.16.4&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>At this point you don’t need express or npm installed in your host, because remember dockerfile handles setting up all the dependencies, lib and configurations.</p> <h3 id="dockerfile"><a href="#dockerfile" aria-hidden="true" class="header-anchor">#</a> DockerFile</h3> <p>Let’s create dockerfile and save it inside our <code>my-node-app</code> folder. This file has no extension and is named <code>Dockerfile</code> . Let go ahead and add following code to our dockerfile.</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-text"><code># Dockerfile
FROM node:8
WORKDIR /app
COPY package.json /app
RUN npm install
COPY . /app
EXPOSE 8081
CMD node index.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><strong>FROM node:8</strong> - pulls node.js docker image from docker hub, which can be found here https://hub.docker.com/_/node/</li> <li><strong>WORKDIR /app</strong> - this sets working directory for our code in image, it is used by all the subsequent commands such as <code>COPY</code> , <code>RUN</code> and <code>CMD</code></li> <li><strong>COPY package.json /app</strong> -this copies our <code>package.json</code> from host <code>my-node-app</code> folder to our image in <code>/app</code> folder.</li> <li><strong>RUN npm install</strong> — we are running this command inside our image to install <code>dependencies</code> (node_modules) for our app.</li> <li><strong>COPY . /app</strong> — we are telling docker to copy our files from <code>my-node-ap</code>p folder and paste it to <code>/app</code> in docker image.</li> <li><strong>EXPOSE 8081</strong> — we are exposing a port on the container using this command. Why this port ? because in our server in index.js is listening on 8081. By default containers created from this image will ignore all the requests made to it.</li></ul> <h3 id="build-docker-image"><a href="#build-docker-image" aria-hidden="true" class="header-anchor">#</a> Build Docker Image</h3> <p>Show time. Open terminal , go to your folder my-node-app and type following command:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Build a image docker build -t &lt;image-name&gt; &lt;relative-path-to-your-dockerfile&gt;</span>

docker build -t hello-world <span class="token keyword">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This command creates a hello-world image on our host.</p> <ul><li><strong>-t</strong> is used to give a name to our image which is <code>hello-world</code> here.</li> <li><strong>.</strong> is the relative path to docker file, since we are in folder <code>my-node-app</code> we used dot to represent path to docker file.</li></ul> <p>You will see an output on your command line something like this:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Sending build context to Docker daemon  4.096kB
Step 1/7 : FROM node:8
    ---&gt; 4f01e5319662
Step 2/7 : WORKDIR /app
    ---&gt; Using cache
    ---&gt; 5c173b2c7b76
Step 3/7 : COPY package.json /app
    ---&gt; Using cache
    ---&gt; ceb27a57f18e
Step 4/7 : RUN npm install
    ---&gt; Using cache
    ---&gt; c1baaf16812a
Step 5/7 : COPY . /app
    ---&gt; 4a770927e8e8
Step 6/7 : EXPOSE 8081
    ---&gt; Running in 2b3f11daff5e
Removing intermediate container 2b3f11daff5e
    ---&gt; 81a7ce14340a
Step 7/7 : CMD node index.js
    ---&gt; Running in 3791dd7f5149
Removing intermediate container 3791dd7f5149
    ---&gt; c80301fa07b2
Successfully built c80301fa07b2
Successfully tagged hello-world:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>As you can see it ran the steps in our docker file and output a docker image. When you try it first time it will take a few minutes, but from next time it will start to use the cache and build much faster and output will be like the one shown above. Now, try following command in your terminal to see if your image is there or not :</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Get a list of images on your host</span>
docker images
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>it should have a list of images in your host. something like this</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>REPOSITORY    TAG      IMAGE ID      CREATED         SIZE
hello-world   latest   c80301fa07b2  22 minutes ago  896MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="run-docker-container"><a href="#run-docker-container" aria-hidden="true" class="header-anchor">#</a> Run Docker Container</h3> <p>With our images created we can spin up a container from this image.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Default command for this is docker container run &lt;image-name&gt;</span>
docker container run -p 4000:8081  hello-world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>This command is used to create and run a docker container.</p> <ul><li><p><strong>-p 4000:8081</strong> — this is publish flag, it maps host port 4000 to container port 8081 which we opened through expose command in dockerfile. Now all the requests to host port 4000 will be listened by container port 8081.</p></li> <li><p><strong>hello-world</strong> — this is the name we gave our image earlier when we ran docker-build command.</p></li></ul> <p>You will receive some output like this :</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app listening on port 8081!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>If you want to enter your container and mount a bash terminal to it you can run</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Enter the container</span>
docker <span class="token function">exec</span> -ti <span class="token operator">&lt;</span>container id<span class="token operator">&gt;</span> /bin/bash
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>In order to check if container is running or not, open another terminal and type</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token function">ps</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You should see your running container like this</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    CONTAINER ID    IMAGE        COMMAND                  CREATED
`&lt;container id&gt;`  hello-world  &quot;/bin/sh -c 'node in…&quot;   11 seconds ago

STATUS              PORTS                    NAMES
Up 11 seconds       0.0.0.0:4000-&gt;8081/tcp   some-random-name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>It means our container with id <code>&lt;container id&gt;</code> created from hello-world image, is up and running and listening to port 8081.
Now our small Node.js app is completely containerised. You can run http://localhost:4000/ on your browser</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">7/17/2019, 6:22:38 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/notebook-devops/docker/react.html" class="prev">
          React项目部署
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notebook-devops/assets/js/app.5041fe57.js" defer></script><script src="/notebook-devops/assets/js/2.c3326ad1.js" defer></script><script src="/notebook-devops/assets/js/10.b17c6e86.js" defer></script>
  </body>
</html>
